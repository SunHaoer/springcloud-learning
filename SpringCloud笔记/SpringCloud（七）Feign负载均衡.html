<html>
<head>
  <title>SpringCloud（七）Feign负载均衡</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/600986 (zh-CN, DDL); Windows/10.0.0 (Win64); EDAMVersion=V2;"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="789"/>
<h1>SpringCloud（七）Feign负载均衡</h1>

<div>
<span><div><h1>Feign负载均衡</h1><div style="margin-top: 1em; margin-bottom: 1em;"><span style="-en-paragraph:true;">Feign是一个声明式WebService客户端，使用Feign能够让编写Web Service客户端变得更简单，它的使用方法就是定义一个接口，然后在上面添加注解。SpringCloud对Feign进行了封装，支持SpringMVC注解和HTTPMessageConverters，Feign可以与Eureka和Ribbon组合使用以支持负载均衡。简单讲，只需要创建一个接口，然后在上面使用注解即可。</span></div><h2>Feign使用步骤</h2><div style="margin-top: 1em; margin-bottom: 1em;"><span style="-en-paragraph:true;">参考项目microservicecloud-consumer-dept-80新建microservicecloud-consumer-dept-feign,拷贝相应的包和配置文件，去掉IRule等信息，修改pom.xml文件，添加对Feign的支持</span></div><h3>pom.xml文件</h3><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;</div><div>  &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;</div><div>  &lt;parent&gt;</div><div>    &lt;groupId&gt;com.luo.springcloud&lt;/groupId&gt;</div><div>    &lt;artifactId&gt;microservicecloud&lt;/artifactId&gt;</div><div>    &lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt;</div><div>  &lt;/parent&gt;</div><div>  &lt;artifactId&gt;microservicecloud-consumer-dept-feign&lt;/artifactId&gt;</div><div>&lt;dependencies&gt;</div><div>        &lt;dependency&gt;&lt;!-- 自己定义的api --&gt;</div><div>            &lt;groupId&gt;com.luo.springcloud&lt;/groupId&gt;</div><div>            &lt;artifactId&gt;microservicecloud-api&lt;/artifactId&gt;</div><div>            &lt;version&gt;${project.version}&lt;/version&gt;</div><div>        &lt;/dependency&gt;</div><div>        &lt;dependency&gt;</div><div>            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</div><div>            &lt;artifactId&gt;spring-cloud-starter-feign&lt;/artifactId&gt;</div><div>        &lt;/dependency&gt;</div><div>        &lt;!-- Ribbon相关 --&gt;</div><div>        &lt;dependency&gt;</div><div>            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</div><div>            &lt;artifactId&gt;spring-cloud-starter-eureka&lt;/artifactId&gt;</div><div>        &lt;/dependency&gt;</div><div>        &lt;dependency&gt;</div><div>            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</div><div>            &lt;artifactId&gt;spring-cloud-starter-ribbon&lt;/artifactId&gt;</div><div>        &lt;/dependency&gt;</div><div>        &lt;dependency&gt;</div><div>            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</div><div>            &lt;artifactId&gt;spring-cloud-starter-config&lt;/artifactId&gt;</div><div>        &lt;/dependency&gt;</div><div>        &lt;dependency&gt;</div><div>            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</div><div>            &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;</div><div>        &lt;/dependency&gt;</div><div>        &lt;!-- 修改后立即生效，热部署 --&gt;</div><div>        &lt;dependency&gt;</div><div>            &lt;groupId&gt;org.springframework&lt;/groupId&gt;</div><div>            &lt;artifactId&gt;springloaded&lt;/artifactId&gt;</div><div>        &lt;/dependency&gt;</div><div>        &lt;dependency&gt;</div><div>            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</div><div>            &lt;artifactId&gt;spring-boot-devtools&lt;/artifactId&gt;</div><div>        &lt;/dependency&gt;</div><div>    &lt;/dependencies&gt;</div><div>&lt;/project&gt;</div></div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="-en-paragraph:true;">由于Feign是面向接口编程，为方便接口的互相调用，将接口和公共的方向在项目microservicecloud-api中，因此修改为：</span></div><h3>修改microservicecloud-api工程的pom.xml文件</h3><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>&lt;dependency&gt;</div><div>  &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</div><div>  &lt;artifactId&gt;spring-cloud-starter-feign&lt;/artifactId&gt;</div><div>&lt;/dependency&gt;</div></div><h3>新建DeptClientService接口</h3><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>@FeignClient(value = &quot;MICROSERVICECLOUD-DEPT&quot;)</div><div>public interface DeptClientService {</div><div>        @RequestMapping(value = &quot;/dept/get/{id}&quot;,method = RequestMethod.GET)</div><div>        public Dept get(@PathVariable(&quot;id&quot;) long id);</div><div>        </div><div>        @RequestMapping(value = &quot;/dept/list&quot;,method = RequestMethod.GET)</div><div>        public List&lt;Dept&gt; list();</div><div>        </div><div>        @RequestMapping(value = &quot;/dept/add&quot;, method = RequestMethod.POST)</div><div>        public boolean add(Dept dept);</div><div>}</div></div><div><br/></div><h3>修改microservicecloud-consumer-dept-feign中Controller添加新建的DeptClientService</h3><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>@RestControllerpublic class DeptController_Consumer {</div><div>        @Autowired</div><div>        private DeptClientService service;</div><div>        </div><div>        @RequestMapping(value = &quot;/consumer/dept/get/{id}&quot;)</div><div>        public Dept get(@PathVariable(&quot;id&quot;) Long id){</div><div>                return this.service.get(id);</div><div>        }</div><div>        </div><div>        @RequestMapping(value = &quot;/consumer/dept/list&quot;)</div><div>        public List&lt;Dept&gt; list(){</div><div>                return this.service.list();</div><div>        }</div><div>        </div><div>        @RequestMapping(value = &quot;/consumer/dept/add&quot;)</div><div>        public Object add(Dept dept){</div><div>                return this.add(dept);</div><div>        }</div><div>}</div></div><div><br/></div><h3>修改microservicecloud-consumer-dept-feign主启动类,添加注解</h3><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>@SpringBootApplication@EnableEurekaClient@EnableFeignClients(basePackages = {&quot;com.luo.springcloud&quot;})</div><div>@ComponentScan(&quot;com.luo.springcloud&quot;)</div><div>public class DeptConsumer80_Feign_App {</div><div>        public static void main(String[] args) {</div><div>                SpringApplication.run(DeptConsumer80_Feign_App.class, args);</div><div>        }</div><div>}</div></div><div><br/></div><h3>测试</h3><div style="margin-top: 1em; margin-bottom: 1em;"><span style="-en-paragraph:true;">启动3个Eureka集群，启动三个部门微服务提供者，启动Feign，访问<a href="http://localhost/consumer/dept/list">http://localhost/consumer/dept/list</a>即可</span></div><h3>总结说明</h3><div style="margin-top: 1em; margin-bottom: 1em;"><span style="-en-paragraph:true;">Feign集成了Ribbon，利用Ribbon维护了MicroServiceCloud-Dept的服务列表信息，并通过轮询的方式实现了客户端的复杂均衡，与Ribbon不同的是，通过Feign只需要定义服务绑定接口且以声明式法人方法，优雅而简单的实现服务调用。</span></div><div><br/></div><div><br/></div></div></span>
</div></body></html> 