<html>
<head>
  <title>SpringCloud（三）Eureka服务注册与发现</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/600986 (zh-CN, DDL); Windows/10.0.0 (Win64); EDAMVersion=V2;"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="781"/>
<h1>SpringCloud（三）Eureka服务注册与发现</h1>

<div>
<span><div><h2>Eureka三大角色</h2><ul><li><div>Eureka Server提供服务注册和发现</div></li><li><div>Service Provider服务提供方将自身服务注册到Eureka， 从而使服务消费者能够找到</div></li><li><div>Service Consumer服务消费方从Eureka获取注册服务列表，从而能够消费</div></li></ul><h2>1.Eureka Server注册</h2><div style="margin-top: 1em; margin-bottom: 1em;"><span style="-en-paragraph:true;">在上述项目的父工程中新建microservicecloud-eureka-7001，这个module是Eureka的服务中心</span></div><h3>POM.xml文件</h3><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</div><div>        xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;</div><div>        &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;</div><div>        &lt;parent&gt;</div><div>                &lt;groupId&gt;com.luo.springcloud&lt;/groupId&gt;</div><div>                &lt;artifactId&gt;microservicecloud&lt;/artifactId&gt;</div><div>                &lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt;</div><div>        &lt;/parent&gt;</div><div>        &lt;artifactId&gt;microservicecloud-eureka-7001&lt;/artifactId&gt;</div><div>        &lt;dependencies&gt;</div><div>                &lt;!--eureka-server服务端 --&gt;</div><div>                &lt;dependency&gt;</div><div>                        &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</div><div>                        &lt;artifactId&gt;spring-cloud-starter-eureka-server&lt;/artifactId&gt;</div><div>                &lt;/dependency&gt;</div><div>                &lt;!-- 修改后立即生效，热部署 --&gt;</div><div>                &lt;dependency&gt;</div><div>                        &lt;groupId&gt;org.springframework&lt;/groupId&gt;</div><div>                        &lt;artifactId&gt;springloaded&lt;/artifactId&gt;</div><div>                &lt;/dependency&gt;</div><div>                &lt;dependency&gt;</div><div>                        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</div><div>                        &lt;artifactId&gt;spring-boot-devtools&lt;/artifactId&gt;</div><div>                &lt;/dependency&gt;</div><div>        &lt;/dependencies&gt;</div><div>&lt;/project&gt;</div></div><h3>application.yml文件</h3><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>server:</div><div>  port: 7001</div><div>eureka:</div><div>  instance:</div><div>    hostname: localhost #eureka服务端的实例名称</div><div>  client:</div><div>    register-with-eureka: false     #false表示不向注册中心注册自己。</div><div>    fetch-registry: false     #false表示自己端就是注册中心，我的职责就是维护服务实例，并不需要去检索服务</div><div>    service-url:</div><div>      #单机 defaultZone: http://${eureka.instance.hostname}:${server.port}/eureka/       #设置与Eureka Server交互的地址查询服务和注册服务都需要依赖这个地址（单机）。</div><div>      defaultZone: http://${eureka.instance.hostname}:${server.port}/eureka/</div></div><h3>EurekaServer主启动类</h3><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>@SpringBootApplication</div><div>@EnableEurekaServer// EurekaServer服务器端启动类，接收其它微服务注册进来</div><div>public class EurekaServer7001_App {</div><div>        public static void main(String[] args) {</div><div>                SpringApplication.run(EurekaServer7001_App.class, args);</div><div>        }</div><div>}</div></div><div><br/></div><h3>测试EurekaServer</h3><div style="margin-top: 1em; margin-bottom: 1em;"><span style="-en-paragraph:true;">浏览器输入<a href="http://localhost:7001/">http://localhost:7001/</a>，看到Spring Eureka界面表示成功，这个访问链接和程序中的application.yml配置吻合。</span></div><h2>2.微服务注册</h2><div style="margin-top: 1em; margin-bottom: 1em;"><span style="-en-paragraph:true;">将microservicecloud-provider-dept-8001微服务注册到microservicecloud-eureka-7001中</span></div><h3>修改microservicecloud-provider-dept-8001的POM.xml文件</h3><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>&lt;!-- 将微服务provider侧注册进eureka --&gt;</div><div>&lt;dependency&gt;</div><div>  &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</div><div>  &lt;artifactId&gt;spring-cloud-starter-eureka&lt;/artifactId&gt;</div><div>&lt;/dependency&gt;</div><div>&lt;dependency&gt;</div><div>  &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</div><div>  &lt;artifactId&gt;spring-cloud-starter-config&lt;/artifactId&gt;</div><div>&lt;/dependency&gt;</div><div><br/></div><div><br/></div></div><h3>修改microservicecloud-provider-dept-8001的application.yml文件</h3><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>eureka:</div><div>  client: #客户端注册进eureka服务列表内</div><div>    service-url:</div><div>      defaultZone: http://localhost:7001/eureka</div></div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="-en-paragraph:true;">说明：defaultZone的地址对应Eureka Server服务注册中心的application.yml中的defaultZone路径</span></div><h3>microservicecloud-provider-dept-8001主程序类使用注解</h3><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>@SpringBootApplication</div><div>@EnableEurekaClient // 本服务启动后会注册到Eureka服务注册中心</div><div>public class DeptProvider8001_App {</div><div>        public static void main(String[] args) {</div><div>                SpringApplication.run(DeptProvider8001_App.class, args);</div><div>        }</div><div>}</div></div><div><br/></div><h3>测试是否注册成功</h3><div style="margin-top: 1em; margin-bottom: 1em;"><span style="-en-paragraph:true;">先启动Eureka服务注册中心microservicecloud-eureka-7001，启动微服务microservicecloud-provider-dept-8001，打开浏览器输入<a href="http://localhost:7001/">http://localhost:7001/</a>，Application下出现</span><span style="font-weight: bold;-en-paragraph:true;">MICROSERVICECLOUD-DEPT</span><span style="-en-paragraph:true;">微服务名称，这个名称来源于microservicecloud-provider-dept-8001中application.ym文件中的配置属性，如下</span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>spring:</div><div>   application:</div><div>    name: microservicecloud-dept</div></div><h2>3.微服务常用设置</h2><h3>主机名称和服务名称修改</h3><div style="margin-top: 1em; margin-bottom: 1em;"><span style="-en-paragraph:true;">在Eureka中注册的微服务的Status的名称显示localhost或者显示电脑主机名，所以要修改服务的主机名称，修改方法如下，修改microservicecloud-provider-dept-8001中application.yml文件，修改后如下</span></div><div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>instance:    </div><div>  instance-id: microservicecloud-dept8001</div><div><br/></div><div><br/></div></div><br/></div><div>访问信息有IP信息提示<br/></div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="-en-paragraph:true;">修改microservicecloud-provider-dept-8001中application.yml文件，修改后如下</span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>instance:    </div><div>  instance-id: microservicecloud-dept8001    </div><div>  prefer-ip-address: true     #访问路径可以显示IP地址 复制代码</div></div><h3>微服务info内容详细信息</h3><div style="margin-top: 1em; margin-bottom: 1em;"><span style="-en-paragraph:true;">增加microservicecloud-provider-dept-8001中POM.xml文件</span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>&lt;!-- actuator监控信息完善 --&gt;&lt;dependency&gt;</div><div>  &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</div><div>  &lt;artifactId&gt;spring-boot-starter-actuator&lt;/artifactId&gt;&lt;/dependency&gt;复制代码</div><div>总的父工程microservicecloud修改pom.xml添加构建build信息</div><div>&lt;build&gt;</div><div>  &lt;finalName&gt;microservicecloud&lt;/finalName&gt;</div><div>  &lt;resources&gt;</div><div>    &lt;resource&gt;</div><div>      &lt;!-- 说明在src/main/resources目录下的配置文件 --&gt;</div><div>      &lt;directory&gt;src/main/resources&lt;/directory&gt;</div><div>      &lt;filtering&gt;true&lt;/filtering&gt;</div><div>    &lt;/resource&gt;</div><div>  &lt;/resources&gt;</div><div>  &lt;plugins&gt;</div><div>    &lt;plugin&gt;</div><div>      &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;</div><div>      &lt;artifactId&gt;maven-resources-plugin&lt;/artifactId&gt;</div><div>      &lt;configuration&gt;</div><div>        &lt;delimiters&gt;</div><div>          &lt;!-- 表示以$开始和以$结束的表示方法 --&gt;</div><div>          &lt;delimit&gt;$&lt;/delimit&gt;</div><div>        &lt;/delimiters&gt;</div><div>      &lt;/configuration&gt;</div><div>    &lt;/plugin&gt;</div><div>  &lt;/plugins&gt;</div><div>&lt;/build&gt;</div></div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="-en-paragraph:true;">修改microservicecloud-provider-dept-8001中application.yml文件，修改后如下</span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>info:</div><div>  app.name: luokangyuan-microservicecloud</div><div>  company.name: www.luokangyuan.com</div><div>  build.artifactId: $project.artifactId$</div><div>  build.version: $project.version$复制代码</div></div><h2><br/></h2><h2>4.Eureka的自我保护机制</h2><h3>导致的原因</h3><div style="margin-top: 1em; margin-bottom: 1em;"><span style="-en-paragraph:true;">默认情况下，如果EurekaServer在一定的时间内没有接收到某一个微服务实例的心跳，EurekaServer将会注销该实例，页面就会看见一串红色提示，但是当网络分区发生故障时，微服务与EurekaServer无法进行正常的通信，此时本不应该注销这个微服务实例，这个时候，Eureka的自我保护机制就可以解决这个问题，当EurekaServer节点在短时间内丢失过多的客户端时（可能发生了网络故障），那么这个节点就会进入自我保护模式，一旦进入该模式，EurekaServer就会保护服务注册表中的信息，不再删除服务注册表中的数据（也就是不会注销任何微服务），当网络故障恢复后，该EurekaServer节点就会自动退出自我保护模式。</span></div><h3>总结</h3><div style="margin-top: 1em; margin-bottom: 1em;"><span style="-en-paragraph:true;">在自我保护模式下，EurekaServer会保护服务注册表中的信息，不再注销任何服务实例，当它收到的心跳数重新到阈值以上，该EurekaServer就会自动退出自我保护模式，也就是宁可保留错误的服务注册信息，也不盲目的删除任何可能健康的服务实例。</span></div><h2>5.服务发现</h2><div style="margin-top: 1em; margin-bottom: 1em;"><span style="-en-paragraph:true;">对于注册近Eureka里面的微服务，可以通过服务发现来获取该服务的信息</span></div><h3>修改microservicecloud-provider-dept-8001的DeptController</h3><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>@Autowiredprivate DiscoveryClient client;</div><div>@RequestMapping(value = &quot;/dept/discovery&quot;, method = RequestMethod.GET)</div><div>public Object discovery(){</div><div>  List&lt;String&gt; list = client.getServices();//得到Eureka中所有的微服务</div><div>  System.out.println(&quot;**********&quot; + list);</div><div>  List&lt;ServiceInstance&gt; srvList = client.getInstances(&quot;MICROSERVICECLOUD-DEPT&quot;);</div><div>  for (ServiceInstance element : srvList) {</div><div>    System.out.println(element.getServiceId() + &quot;\t&quot;</div><div>                       + element.getHost() + &quot;\t&quot; + element.getPort() + &quot;\t&quot;</div><div>                       + element.getUri());</div><div>  }</div><div>  return this.client;</div><div>}</div></div><div><br/></div><h3>microservicecloud-provider-dept-8001主启动类添加注解</h3><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>@SpringBootApplication</div><div>@EnableEurekaClient // 本服务启动后会注册到Eureka服务注册中心</div><div>@EnableDiscoveryClient // 服务发现</div><div>public class DeptProvider8001_App {</div><div>        public static void main(String[] args) {</div><div>                SpringApplication.run(DeptProvider8001_App.class, args);</div><div>        }</div><div>}</div></div><div><br/></div><h3>自测试</h3><div style="margin-top: 1em; margin-bottom: 1em;"><span style="-en-paragraph:true;">启动服务注册中心microservicecloud-eureka-7001，再启动microservicecloud-provider-dept-8001，访问<a href="http://localhost:8001/dept/discovery">http://localhost:8001/dept/discovery</a>可以得到这个服务的info信息，/dept/discovery接口就是microservicecloud-provider-dept-8001这个服务暴露给外部访问的接口。使用<a href="http://localhost:8001/dept/discovery">http://localhost:8001/dept/discovery</a>测试，就是自己测试能不能使用</span></div><h3>外部访服务暴露的接口</h3><div style="margin-top: 1em; margin-bottom: 1em;"><span style="-en-paragraph:true;">microservicecloud-consumer-dept-80调用microservicecloud-provider-dept-8001服务暴露在外的接口，修改microservicecloud-consumer-dept-80中的DeptController_Consumer，如下</span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>// 测试@EnableDiscoveryClient,消费端可以调用服务发现@RequestMapping(value = &quot;/consumer/dept/discovery&quot;)</div><div>public Object discovery(){</div><div>  return restTemplate.getForObject(REST_URL_PREFIX + &quot;/dept/discovery&quot;, Object.class);</div><div>}</div></div><div><br/></div><h3>消费者访问接口测试</h3><div style="margin-top: 1em; margin-bottom: 1em;"><span style="-en-paragraph:true;">启动microservicecloud-consumer-dept-80访问<a href="http://localhost/consumer/dept/discovery">http://localhost/consumer/dept/discovery</a>得到8001微服务信息</span></div><h3>总结</h3><ul><li><div>microservicecloud-provider-dept-8001注册到EurekaServer服务中心</div></li><li><div>microservicecloud-provider-dept-8001将Controller中的某一个方法暴露出去（提供服务发现）</div></li><li><div>microservicecloud-consumer-dept-80中的Controller就可以调用微服务暴露出来的接口</div></li></ul><div><br/></div><div><br/></div></div></span>
</div></body></html> 