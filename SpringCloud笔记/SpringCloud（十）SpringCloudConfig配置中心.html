<html>
<head>
  <title>SpringCloud（十）SpringCloudConfig配置中心</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/600986 (zh-CN, DDL); Windows/10.0.0 (Win64); EDAMVersion=V2;"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="795"/>
<h1>SpringCloud（十）SpringCloudConfig配置中心</h1>

<div>
<span><div><h2>概述</h2><div style="margin-top: 1em; margin-bottom: 1em;"><span style="-en-paragraph:true;">就前面项目而言，分布面临的问题是配置问题，每一个项目都有一个yml文件，不好运维管理，所有需要一套集中式，动态的配置管理设施，SpringCloud提供了ConfigServer来解决这个问题。</span></div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="-en-paragraph:true;">SpringCloud Config是为微服务架构中的微服务提供集中化的外部配置支持，配置服务器为</span> <span style="font-weight: bold;-en-paragraph:true;">各个不同的微服务应用</span><span style="-en-paragraph:true;">的环境提供了一个</span> <span style="font-weight: bold;-en-paragraph:true;">中心化的外部配置</span><span style="-en-paragraph:true;">。SpringCloud Config分为客户端和服务端，服务端也称</span> <span style="font-weight: bold;-en-paragraph:true;">分布式配置中心，它是一个独立的微服务应用</span><span style="-en-paragraph:true;">，用来连接配置服务器并为客户端提供获取配置信息，加密和解密信息等访问接口，客户端是通过指定的配置中心获取和加载配置信息配置服务器默认采用git来存储配置信息，这样就有助于对环境配置进行版本管理，并且可以通过git客户端工具管理和访问配置内容。</span></div><h2>作用</h2><ul><li><div>集中管理配置文件</div></li><li><div>不同环境下不同配置，动态化的配置更新，分环境部署等</div></li><li><div>运行期间动态调整配置，不需要在每一个服务部署的机器编码上编写文件，服务会向配置中心拉取自己的配置信息</div></li><li><div>当配置发生变动时，服务不需要重启即可感知配置的变化并应用新的配置</div></li><li><div>将配置信息以REST接口的形式暴露</div></li></ul><h2>config服务端与GitHub通信</h2><div style="margin-top: 1em; margin-bottom: 1em;"><span style="font-weight: bold;-en-paragraph:true;">GitHUb上新建一个microservicecloud-config的Repository</span></div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="font-weight: bold;-en-paragraph:true;">本地硬盘目录新建git仓库并clone</span></div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="font-weight: bold;-en-paragraph:true;">在D:\workspace2018\micorservicecloude-config\microservicecloud-config新建application.yml文件</span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>Spring:</div><div>    profiles:</div><div>    active:</div><div>    - dev</div><div>---</div><div>Spring:</div><div>    profiles: dev</div><div>    application:</div><div>        name: micorservicecloud-config-luo-dev</div><div>---</div><div>Spring:</div><div>    profiles: test</div><div>    application:</div><div>        name: micorservicecloud-config-luo-test</div></div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="font-weight: bold;-en-paragraph:true;">注意保存为utf-8的文件格式</span></div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="font-weight: bold;-en-paragraph:true;">将yml文件推送到GitHub上</span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>git add .</div><div>git commit -m&quot;&quot;</div><div>git push origin master</div></div><div><br/></div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="font-weight: bold;-en-paragraph:true;">新建项目microservicecloud-config-3344</span></div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="font-weight: bold;-en-paragraph:true;">POM.xml文件</span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;</div><div>  &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;</div><div>  &lt;parent&gt;</div><div>    &lt;groupId&gt;com.luo.springcloud&lt;/groupId&gt;</div><div>    &lt;artifactId&gt;microservicecloud&lt;/artifactId&gt;</div><div>    &lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt;</div><div>  &lt;/parent&gt;</div><div>  &lt;artifactId&gt;microservicecloud-config-3344&lt;/artifactId&gt;&lt;dependencies&gt;</div><div>                &lt;!-- springCloud Config --&gt;</div><div>                &lt;dependency&gt;</div><div>                        &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</div><div>                        &lt;artifactId&gt;spring-cloud-config-server&lt;/artifactId&gt;</div><div>                &lt;/dependency&gt;</div><div>                &lt;!-- 避免Config的Git插件报错：org/eclipse/jgit/api/TransportConfigCallback --&gt;</div><div>                &lt;dependency&gt;</div><div>                        &lt;groupId&gt;org.eclipse.jgit&lt;/groupId&gt;</div><div>                        &lt;artifactId&gt;org.eclipse.jgit&lt;/artifactId&gt;</div><div>                        &lt;version&gt;4.10.0.201712302008-r&lt;/version&gt;</div><div>                &lt;/dependency&gt;</div><div>                &lt;!-- 图形化监控 --&gt;</div><div>                &lt;dependency&gt;</div><div>                        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</div><div>                        &lt;artifactId&gt;spring-boot-starter-actuator&lt;/artifactId&gt;</div><div>                &lt;/dependency&gt;</div><div>                &lt;!-- 熔断 --&gt;</div><div>                &lt;dependency&gt;</div><div>                        &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</div><div>                        &lt;artifactId&gt;spring-cloud-starter-hystrix&lt;/artifactId&gt;</div><div>                &lt;/dependency&gt;</div><div>                &lt;dependency&gt;</div><div>                        &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</div><div>                        &lt;artifactId&gt;spring-cloud-starter-eureka&lt;/artifactId&gt;</div><div>                &lt;/dependency&gt;</div><div>                &lt;dependency&gt;</div><div>                        &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</div><div>                        &lt;artifactId&gt;spring-cloud-starter-config&lt;/artifactId&gt;</div><div>                &lt;/dependency&gt;</div><div>                &lt;dependency&gt;</div><div>                        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</div><div>                        &lt;artifactId&gt;spring-boot-starter-jetty&lt;/artifactId&gt;</div><div>                &lt;/dependency&gt;</div><div>                &lt;dependency&gt;</div><div>                        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</div><div>                        &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;</div><div>                &lt;/dependency&gt;</div><div>                &lt;dependency&gt;</div><div>                        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</div><div>                        &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;</div><div>                &lt;/dependency&gt;</div><div>                &lt;!-- 热部署插件 --&gt;</div><div>                &lt;dependency&gt;</div><div>                        &lt;groupId&gt;org.springframework&lt;/groupId&gt;</div><div>                        &lt;artifactId&gt;springloaded&lt;/artifactId&gt;</div><div>                &lt;/dependency&gt;</div><div>                &lt;dependency&gt;</div><div>                        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</div><div>                        &lt;artifactId&gt;spring-boot-devtools&lt;/artifactId&gt;</div><div>                &lt;/dependency&gt;</div><div>        &lt;/dependencies&gt;</div><div>&lt;/project&gt;</div></div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="font-weight: bold;-en-paragraph:true;"><br/></span></div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="font-weight: bold;-en-paragraph:true;">application.yml文件</span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>server:</div><div>  port: 3344</div><div>  </div><div>spring:</div><div>  application:</div><div>    name:  microservicecloud-config</div><div>  cloud:</div><div>    config:</div><div>      server:</div><div>        git:</div><div>          uri: git@github.com:luokangyuan/microservicecloud-config.git #GitHub上面的git仓库名字</div></div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="font-weight: bold;-en-paragraph:true;"><br/></span></div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="font-weight: bold;-en-paragraph:true;">主启动类</span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>@SpringBootApplication</div><div>@EnableConfigServer</div><div>public class Config_3344_StartSpringCloudApp {</div><div>        public static void main(String[] args) {</div><div>                SpringApplication.run(Config_3344_StartSpringCloudApp.class, args);</div><div>        }</div><div>}</div></div><div><br/></div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="font-weight: bold;-en-paragraph:true;">修改host文件</span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>127.0.0.1 config-3344.com</div></div><div><br/></div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="font-weight: bold;-en-paragraph:true;">测试通过config微服务从GitHub上获取配置内容</span></div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="-en-paragraph:true;">启动服务3344，访问<a href="http://config-3344.com:3344/application-dev.yml">http://config-3344.com:3344/application-dev.yml</a>，<a href="http://config-3344.com:3344/application-test.yml">http://config-3344.com:3344/application-test.yml</a></span></div><h2>config客户端获取github配置</h2><div style="margin-top: 1em; margin-bottom: 1em;"><span style="font-weight: bold;-en-paragraph:true;">本地新建microservicecloud-config-client.yml文件,并推送到github</span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>server:</div><div>    port: 8201</div><div>spring:</div><div>    profiles: dev</div><div>    application:</div><div>        name: microservicecloud-config-client</div><div>eureka:</div><div>    client:</div><div>        service-url:</div><div>            defaultZone: http://eureka-dev.com:7001/eureka/</div><div>---</div><div>server:</div><div>    port: 8202</div><div>spring:</div><div>    profiles: test</div><div>    application:</div><div>        name: microservicecloud-config-client</div><div>eureka:</div><div>    client:</div><div>        service-url:</div><div>            defaultZone: http://eureka-test.com:7001/eureka/</div></div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="font-weight: bold;-en-paragraph:true;"><br/></span></div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="font-weight: bold;-en-paragraph:true;">新建项目microservicecloud-config-client-3355，pom.xml文件如下</span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</div><div>        xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;</div><div>        &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;</div><div>        &lt;parent&gt;</div><div>                &lt;groupId&gt;com.luo.springcloud&lt;/groupId&gt;</div><div>                &lt;artifactId&gt;microservicecloud&lt;/artifactId&gt;</div><div>                &lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt;</div><div>        &lt;/parent&gt;</div><div>        &lt;artifactId&gt;microservicecloud-config-client-3355&lt;/artifactId&gt;</div><div>        &lt;dependencies&gt;</div><div>                &lt;!-- SpringCloud Config客户端 --&gt;</div><div>                &lt;dependency&gt;</div><div>                        &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</div><div>                        &lt;artifactId&gt;spring-cloud-starter-config&lt;/artifactId&gt;</div><div>                &lt;/dependency&gt;</div><div>                &lt;dependency&gt;</div><div>                        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</div><div>                        &lt;artifactId&gt;spring-boot-starter-actuator&lt;/artifactId&gt;</div><div>                &lt;/dependency&gt;</div><div>                &lt;dependency&gt;</div><div>                        &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</div><div>                        &lt;artifactId&gt;spring-cloud-starter-hystrix&lt;/artifactId&gt;</div><div>                &lt;/dependency&gt;</div><div>                &lt;dependency&gt;</div><div>                        &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</div><div>                        &lt;artifactId&gt;spring-cloud-starter-eureka&lt;/artifactId&gt;</div><div>                &lt;/dependency&gt;</div><div>                &lt;dependency&gt;</div><div>                        &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</div><div>                        &lt;artifactId&gt;spring-cloud-starter-config&lt;/artifactId&gt;</div><div>                &lt;/dependency&gt;</div><div>                &lt;dependency&gt;</div><div>                        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</div><div>                        &lt;artifactId&gt;spring-boot-starter-jetty&lt;/artifactId&gt;</div><div>                &lt;/dependency&gt;</div><div>                &lt;dependency&gt;</div><div>                        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</div><div>                        &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;</div><div>                &lt;/dependency&gt;</div><div>                &lt;dependency&gt;</div><div>                        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</div><div>                        &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;</div><div>                &lt;/dependency&gt;</div><div>                &lt;dependency&gt;</div><div>                        &lt;groupId&gt;org.springframework&lt;/groupId&gt;</div><div>                        &lt;artifactId&gt;springloaded&lt;/artifactId&gt;</div><div>                &lt;/dependency&gt;</div><div>                &lt;dependency&gt;</div><div>                        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</div><div>                        &lt;artifactId&gt;spring-boot-devtools&lt;/artifactId&gt;</div><div>                &lt;/dependency&gt;</div><div>        &lt;/dependencies&gt;</div><div>&lt;/project&gt;</div></div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="font-weight: bold;-en-paragraph:true;"><br/></span></div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="font-weight: bold;-en-paragraph:true;">新建bootstrap.yml文件</span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>spring:</div><div>  cloud:</div><div>    config:</div><div>      name: microservicecloud-config-client #需要从github上读取的资源名称，注意没有yml后缀名</div><div>      profile: test   #本次访问的配置项</div><div>      label: master   </div><div>      uri: http://config-3344.com:3344  #本微服务启动后先去找3344号服务，通过SpringCloudConfig获取GitHub的服务地址</div></div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="-en-paragraph:true;">application.yml是用户级的资源配置文件，bootstrap.yml是系统级，优先级更高，保证不会被本地配置文件所覆盖</span></div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="font-weight: bold;-en-paragraph:true;">修改host文件，增加映射</span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>127.0.0.1 client-config.com</div></div><div><br/></div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="font-weight: bold;-en-paragraph:true;">新建测试controller，从github读取配置信息</span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>package com.luo.springcloud.rest;</div><div>import org.springframework.beans.factory.annotation.Value;</div><div>import org.springframework.web.bind.annotation.RequestMapping;</div><div>import org.springframework.web.bind.annotation.RestController;</div><div>@RestController</div><div>public class ConfigClientRest{</div><div>        @Value(&quot;${spring.application.name}&quot;)</div><div>        private String applicationName;</div><div>        @Value(&quot;${eureka.client.service-url.defaultZone}&quot;)</div><div>        private String eurekaServers;</div><div>        @Value(&quot;${server.port}&quot;)</div><div>        private String port;</div><div>        @RequestMapping(&quot;/config&quot;)</div><div>        public String getConfig()</div><div>        {</div><div>                String str = &quot;applicationName: &quot; + applicationName + &quot;\t eurekaServers:&quot; + eurekaServers + &quot;\t port: &quot; + port;</div><div>                System.out.println(&quot;******str: &quot; + str);</div><div>                return &quot;applicationName: &quot; + applicationName + &quot;\t eurekaServers:&quot; + eurekaServers + &quot;\t port: &quot; + port;</div><div>        }</div><div>}</div></div><div><br/></div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="font-weight: bold;-en-paragraph:true;">新建主启动类</span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>@SpringBootApplicationpublic class ConfigClient_3355_StartSpringCloudApp {</div><div>        public static void main(String[] args) {</div><div>                SpringApplication.run(ConfigClient_3355_StartSpringCloudApp.class, args);</div><div>        }</div><div>}</div></div><div><br/></div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="font-weight: bold;-en-paragraph:true;">测试</span></div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="-en-paragraph:true;">启动3344服务，启动3355服务，bootstrap.yml中的profile值是什么，决定从github上读取什么,ruguo</span></div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="-en-paragraph:true;">访问<a href="http://client-config.com:8201/config">http://client-config.com:8201/config</a>得到是github上的microservicecloud-config-client.yml文件中dev相关的配置信息</span></div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="-en-paragraph:true;">访问<a href="http://client-config.com:8202/config">http://client-config.com:8202/config</a>得到是github上的microservicecloud-config-client.yml文件中test相关的配置信息</span></div><div><br/></div><div><br/></div></div></span>
</div></body></html> 